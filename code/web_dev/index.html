<!DOCTYPE html>

<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<title>Image Conversion</title>
		<script>
            function load_image( event ) {
                var canvas = document.getElementById("id_canvas");
                var context = canvas.getContext("2d");
                var image = new Image();
                image.onload = function() {
                    canvas.width  = image.width; 
                    canvas.height = image.height;
                    context.drawImage(image, 0, 0);
                };
                image.src = URL.createObjectURL(event.target.files[0]);
            }
            function spinnerfly_image() {
                var canvas = document.getElementById("id_canvas");
                var context = canvas.getContext("2d");
                var image_data = context.getImageData( 0, 0, canvas.width, canvas.height );
                // var bin_data = new Uint8Array( image_data.data.length);
                // for( var i=0; i < image_data.data.length; i++ ) {
                //     bin_data[i] = image_data.data[i];
                // }
               
                var bin_data = [];
                var d =  Math.min( canvas.width, canvas.height );
                var center_x = Math.floor(canvas.width / 2);
                var center_y = Math.floor(canvas.height / 2);
                for( var deg = 0; deg < 360; deg++ ) {
                    for( var led = 0; led < 15; led++ ) {
                        var r = Math.round( led * d / (2*15) );
                        var [x,y] = polar_to_cart( deg, r, center_x, center_y );
                        var [r,b,g] = get_rbg_data( x, y, image_data );
                        bin_data.push(r,b,g);
                    }
                }

                /* Test download */
                var blob = new Blob([new Uint8Array(bin_data)], {type:'application/octet-stream'});
                var url = URL.createObjectURL(blob);
                var link = document.createElement("a");
                link.href = url;
                link.download = "superFly.bin";
                link.click();
            }
            function get_rbg_data( x, y, image_data ) {
                var idx = (x + (y * image_data.width)) * 4;
                var r = image_data.data[idx + 0];
                var g = image_data.data[idx + 1];
                var b = image_data.data[idx + 2];
                var a = image_data.data[idx + 3];
                return[r,b,g];
            }
            function polar_to_cart( deg, r, x_offset, y_offset) {
                var rads = ( deg * Math.PI) / 180.0;
                var x = Math.floor(Math.cos( rads ) * r);
                var y = Math.floor(Math.sin( rads ) * r);
                x += x_offset;
                y += y_offset;
                return[x,y];
            }
		</script>
	</head>
	<body>
        <input type="file" accept="image/*" onchange="load_image(event)">
        <canvas id="id_canvas"></canvas>
        <button onclick="spinnerfly_image()">Spinnerfly</button>
	</body>
</html>
